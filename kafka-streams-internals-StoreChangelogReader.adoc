== [[StoreChangelogReader]] StoreChangelogReader

`StoreChangelogReader` is a concrete <<kafka-streams-internals-ChangelogReader.adoc#, ChangelogReader>> that is used for the following:

* <<kafka-streams-internals-AbstractTask.adoc#, Tasks>> to create a <<kafka-streams-internals-ProcessorStateManager.adoc#, ProcessorStateManager>>

* <<kafka-streams-internals-TaskManager.adoc#, TaskManager>> when <<kafka-streams-internals-TaskManager.adoc#suspendTasksAndState, suspending all (active and standby) tasks and state>> (at the <<kafka-streams-StreamThread-RebalanceListener.adoc#onPartitionsRevoked, beginning of consumer rebalance>>) and <<kafka-streams-internals-TaskManager.adoc#updateNewAndRestoringTasks, updateNewAndRestoringTasks>> (at the <<kafka-streams-StreamThread-RebalanceListener.adoc#onPartitionsAssigned, end of consumer rebalance>>)

`StoreChangelogReader` is <<creating-instance, created>> for a <<kafka-streams-internals-StreamThread.adoc#, StreamThread>> for the only purpose of creating the <<kafka-streams-internals-TaskCreator.adoc#storeChangelogReader, TaskCreator>>, the <<kafka-streams-internals-StandbyTaskCreator.adoc#storeChangelogReader, StandbyTaskCreator>> and the <<kafka-streams-internals-TaskManager.adoc#changelogReader, TaskManager>>.

.StoreChangelogReader
image::images/kafka-streams-StoreChangelogReader.png[align="center"]

When <<creating-instance, created>>, `StoreChangelogReader` is given the <<pollTime, pollTime>> that is configured using <<kafka-streams-StreamsConfig.adoc#POLL_MS_CONFIG, StreamsConfig.POLL_MS_CONFIG>> configuration property.

`StoreChangelogReader` uses the <<userStateRestoreListener, StateRestoreListener>> exclusively when <<register, registering a StateRestorer>>.

=== [[creating-instance]] Creating StoreChangelogReader Instance

`StoreChangelogReader` takes the following to be created:

* [[restoreConsumer]] *Restore Consumer* (`Consumer<byte[], byte[]>`)
* [[pollTime]] `pollTime`
* [[userStateRestoreListener]] <<kafka-streams-StateRestoreListener.adoc#, StateRestoreListener>>
* [[logContext]] `LogContext`

`StoreChangelogReader` initializes the <<internal-properties, internal properties>>.

=== [[register]] Registering StateRestorer (For Changelog Partition) -- `register` Method

[source, java]
----
void register(StateRestorer restorer)
----

NOTE: `register` is part of link:kafka-streams-internals-ChangelogReader.adoc#register[ChangelogReader Contract] to register a <<kafka-streams-internals-StateRestorer.adoc#, StateRestorer>> (for a changelog partition).

`register`...FIXME

=== [[reset]] `reset` Method

[source, java]
----
void reset()
----

NOTE: `reset` is part of link:kafka-streams-internals-ChangelogReader.adoc#reset[ChangelogReader Contract] to...FIXME.

`reset`...FIXME

=== [[restore]] `restore` Method

[source, java]
----
Collection<TopicPartition> restore(RestoringTasks active)
----

NOTE: `restore` is part of the <<kafka-streams-internals-ChangelogReader.adoc#restore, ChangelogReader Contract>> to...FIXME.

`restore`...FIXME

=== [[restoredOffsets]] `restoredOffsets` Method

[source, java]
----
Map<TopicPartition, Long> restoredOffsets()
----

NOTE: `restoredOffsets` is part of <<kafka-streams-internals-ChangelogReader.adoc#restoredOffsets, ChangelogReader Contract>> to restore offsets.

`restoredOffsets` returns pairs of `TopicPartition` and <<kafka-streams-internals-StateRestorer.adoc#restoredOffset, restoredOffset>> (from the associated <<kafka-streams-internals-StateRestorer.adoc#, StateRestorer>> that is <<kafka-streams-internals-StateRestorer.adoc#isPersistent, persistent>> for the <<kafka-streams-internals-StateRestorer.adoc#storeName, state store>> that is <<kafka-streams-StateStore.adoc#persistent, persistent>>).

Internally, for every pair of `TopicPartition` and <<kafka-streams-internals-StateRestorer.adoc#, StateRestorer>> (in the <<stateRestorers, stateRestorers>> internal registry), `restoredOffsets` requests the `StateRestorer` to <<kafka-streams-internals-StateRestorer.adoc#restoredOffset, restoredOffset>> when the restorer is <<kafka-streams-internals-StateRestorer.adoc#isPersistent, persistent>> (i.e. when the <<kafka-streams-internals-StateRestorer.adoc#storeName, associated state store>> is <<kafka-streams-StateStore.adoc#persistent, persistent>>).

=== [[processNext]] `processNext` Internal Method

[source, java]
----
long processNext(
  final List<ConsumerRecord<byte[], byte[]>> records,
  final StateRestorer restorer,
  final Long endOffset)
----

`processNext`...FIXME

NOTE: `processNext` is used exclusively when `StoreChangelogReader` is requested to <<restore, restore>>.

=== [[startRestoration]] `startRestoration` Internal Method

[source, java]
----
void startRestoration(final Map<TopicPartition, StateRestorer> initialized)
----

`startRestoration`...FIXME

NOTE: `startRestoration` is used exclusively when `StoreChangelogReader` is requested to <<initialize, initialize>> (when requested to <<restore, restore>>).

=== [[initialize]] `initialize` Internal Method

[source, java]
----
void initialize(RestoringTasks active)
----

`initialize`...FIXME

NOTE: `initialize` is used exclusively when `StateRestorer` is requested to <<restore, restore>> (and there are <<needsInitializing, needsInitializing>> changelog partitions).

=== [[internal-properties]] Internal Properties

[cols="30m,70",options="header",width="100%"]
|===
| Name
| Description

| endOffsets
| [[endOffsets]]

| needsInitializing
a| [[needsInitializing]] Changelog partitions (of <<kafka-streams-internals-StateRestorer.adoc#, StateRestorers>>) that need initializing (`Set<TopicPartition>`)

* New changelog partitions added in <<register, register>>

* Changelog partition removed in <<initialize, initialize>> (<<restore, restore>>) and <<startRestoration, startRestoration>>

* All changelog partitions removed in <<reset, reset>>

Used in <<restore, restore>>

| needsRestoring
| [[needsRestoring]]

| partitionInfo
| [[partitionInfo]]

| stateRestorers
a| [[stateRestorers]] <<kafka-streams-internals-StateRestorer.adoc#, StateRestorers>> per changelog partition (`Map<TopicPartition, StateRestorer>`)

* New `StateRestorer` added in <<register, register>>

* All `StateRestorers` removed in <<reset, reset>>

Used in <<restore, restore>>, and <<restoredOffsets, restoredOffsets>>

|===
